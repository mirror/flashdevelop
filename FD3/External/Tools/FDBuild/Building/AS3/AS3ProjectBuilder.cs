using System;
using System.Collections.Generic;
using System.Runtime.Remoting.Channels.Ipc;
using System.Text;
using ProjectManager.Projects.AS3;
using ProjectManager.Helpers;
using System.IO;
using FDBuild.Building.AS3;

namespace ProjectManager.Building.AS3
{
    public class AS3ProjectBuilder : ProjectBuilder
    {
        AS3Project project;
        FlexCompilerShell fcsh;

        string mxmlcPath;
        string fcshPath;

        public AS3ProjectBuilder(AS3Project project, string compilerPath, string ipcName)
            : base(project, compilerPath)
        {
            this.project = project;

            DetectFlex2Sdk(compilerPath);

            bool hostedInFD = (ipcName != null && ipcName != "");
            bool mxmlcExists = File.Exists(mxmlcPath);
            bool fcshExists = File.Exists(fcshPath);

            if (!mxmlcExists && !project.NoOutput)
                throw new Exception("Could not find mxmlc.exe.  Please set the correct path to the Flex2 SDK in the Project Manager settings dialog.");

            if (hostedInFD && !fcshExists)
                Console.WriteLine("HINT: Improve your build speed when compiling in FlashDevelop3 by placing the Adobe Flex Compiler Shell in your Flex2 bin path.");

            if (hostedInFD && fcshExists)
            {
                Console.WriteLine("Using the Flex Compiler Shell.");

                fcsh = Activator.GetObject(typeof(FlexCompilerShell),
                    "ipc://" + ipcName + "/FlexCompilerShell") as FlexCompilerShell;
            }
        }

        #region Grab Flex2 SDK Path from Project Manager

        private void DetectFlex2Sdk(string flex2sdkPath)
        {
            // path provided in program arguments
            if (flex2sdkPath != null && Directory.Exists(flex2sdkPath))
            {
                string binPath = flex2sdkPath.EndsWith("bin") ? flex2sdkPath : Path.Combine(flex2sdkPath, "bin");
                mxmlcPath = Path.Combine(binPath, "mxmlc.exe");
                fcshPath = Path.Combine(binPath, "fcsh.exe");
            }
            // search for FDBuildHints.txt in the ProjectManager's Data directory
            else 
            {
                string toolsDir = Path.GetDirectoryName(FDBuildDirectory);
                string firstRunDir = Path.GetDirectoryName(toolsDir);
                string dataDir = Path.Combine(firstRunDir, "Data");
                string pmDir = Path.Combine(dataDir, "ProjectManager");
                string fdbuildHints = Path.Combine(pmDir, "FDBuildHints.txt");

                if (!File.Exists(fdbuildHints))
                {
                    Console.WriteLine("Could not find FDBuildHints.txt, which should be generated by FlashDevelop3 when you run it with the Project Manager plugin installed.");
                    return;
                }

                using (StreamReader reader = File.OpenText(fdbuildHints))
                {
                    flex2sdkPath = reader.ReadLine();
                    string binPath = flex2sdkPath.EndsWith("bin") ? flex2sdkPath : Path.Combine(flex2sdkPath, "bin");
                    mxmlcPath = Path.Combine(binPath, "mxmlc.exe");
                    fcshPath = Path.Combine(binPath, "fcsh.exe");
                }
            }
        }

        #endregion

        protected override void DoBuild(string[] extraClasspaths, bool noTrace)
        {
            string tempFile = null;
            
            Environment.CurrentDirectory = project.Directory;
            try
            {
               
                string objDir = "obj";
                if (!Directory.Exists(objDir)) Directory.CreateDirectory(objDir);
                tempFile = GetTempProjectFile(project);

                //create new config file

                // create compiler configuration file
                string backupConfig = Path.Combine(objDir, project.Name + "Config.old");
                string configFileTmp = Path.Combine(objDir, project.Name + "Config.tmp");
                string configFile = Path.Combine(objDir, project.Name + "Config.xml");

                // backup the old Config.xml to Config.old so we can reference it
                if (File.Exists(configFile))
                    File.Copy(configFile, backupConfig, true);

                //write "new" config to tmp 
                FlexConfigWriter config = new FlexConfigWriter(project.GetAbsolutePath(configFileTmp));
                config.WriteConfig(project, extraClasspaths);

                //compare tmp to current
                bool configChanged = !File.Exists(backupConfig) || !File.Exists(configFile) || !FileComparer.IsEqual(configFileTmp, configFile);

                //copy temp file to config if there is a change
                if (configChanged){
                    File.Copy(configFileTmp, configFile, true);
                }

                //remove temp
                File.Delete(configFileTmp);
                
                MxmlcArgumentBuilder mxmlc = new MxmlcArgumentBuilder(project);

                mxmlc.AddConfig(configFile);
                mxmlc.AddOptions(noTrace == false, fcsh != null);
                mxmlc.AddOutput(tempFile);

                string mxmlcArgs = mxmlc.ToString();

                Console.WriteLine("mxmlc " + mxmlcArgs);

                CompileWithMxmlc(project.Directory, mxmlcArgs, configChanged);

                // if we get here, the build was successful
                string output = project.FixDebugReleasePath(project.OutputPathAbsolute);
                string outputDir = Path.GetDirectoryName(output);
                if (!Directory.Exists(outputDir)) Directory.CreateDirectory(outputDir);
                File.Copy(tempFile, output, true);
            }
            finally { if (tempFile != null && File.Exists(tempFile)) File.Delete(tempFile); }
        }

        public void CompileWithMxmlc(string workingdir, string arguments, bool configChanged)
        {
            if (fcsh != null)
            {
                string output;
                string[] errors;
                fcsh.Compile(workingdir, configChanged, arguments, out output, out errors, fcshPath);

                Console.WriteLine(output);
                foreach (string error in errors)
                    Console.Error.WriteLine(error);

                if (errors.Length > 0)
                    throw new BuildException("Build halted with errors (mxmlc).");
            }
            else
            {
                if (!ProcessRunner.Run(mxmlcPath, arguments, false))
                    throw new BuildException("Build halted with errors (mxmlc).");
            }
        }

        // each project needs to have its own temporary build target that is consistent
        // between builds.  This is necessary because the arguments to the FlexCompilerShell
        // (if you're using it) have to be identical between builds to enable incremental compiling.
        //private string GetTempProjectFile(AS3Project project)
        private string GetTempProjectFile(AS3Project project)
        {
            // this serves two purposes - randomize the filename, so two identically-named
            // projects don't get the same temp build target, and also provide an extra
            // method of forcing a recompile after a project modification.
            long modified = File.GetLastWriteTime(project.ProjectPath).Ticks;
            string tempFileName = project.Name + modified;
            string tempPath = "obj";
            string tempFile = Path.Combine(tempPath, tempFileName);
            File.Create(tempFile).Close();
            return tempFile;
        }
    }
}
